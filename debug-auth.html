<!DOCTYPE html>
<html>
<head>
    <title>Authentication Debug Helper</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { background: #f0f8ff; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        .error { background: #f8d7da; padding: 15px; margin: 10px 0; border-left: 4px solid #dc3545; }
        .success { background: #d4edda; padding: 15px; margin: 10px 0; border-left: 4px solid #28a745; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîê Authentication Debug Helper</h1>
    
    <div class="step">
        <h2>Step 1: Check Current Authentication Status</h2>
        <button onclick="checkAuthStatus()">Check Auth Status</button>
        <div id="authStatus" class="result"></div>
    </div>

    <div class="step">
        <h2>Step 2: Test Login</h2>
        <p>Try logging in with these credentials:</p>
        <div class="code">
            Email: admin@example.com<br>
            Password: password123
        </div>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult" class="result"></div>
    </div>

    <div class="step">
        <h2>Step 3: Test API Access</h2>
        <button onclick="testAPI()">Test API Access</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="step">
        <h2>Step 4: Clear Authentication</h2>
        <button onclick="clearAuth()">Clear Auth & Reload</button>
        <div id="clearResult" class="result"></div>
    </div>

    <div class="error">
        <h2>üö® Common Issues & Solutions</h2>
        <ul>
            <li><strong>Token Expired:</strong> Log out and log back in</li>
            <li><strong>Invalid Token:</strong> Clear localStorage and login again</li>
            <li><strong>Backend Not Running:</strong> Make sure server is running on port 5000</li>
            <li><strong>Wrong Credentials:</strong> Use correct email/password</li>
            <li><strong>Network Error:</strong> Check if backend is accessible</li>
        </ul>
    </div>

    <script>
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let status = '<h3>Current Status:</h3>';
            status += `<p><strong>Token:</strong> ${token ? 'Present' : 'Missing'}</p>`;
            status += `<p><strong>User:</strong> ${user ? 'Logged in' : 'Not logged in'}</p>`;
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const exp = new Date(payload.exp * 1000);
                    const now = new Date();
                    status += `<p><strong>Token Expires:</strong> ${exp.toLocaleString()}</p>`;
                    status += `<p><strong>Token Valid:</strong> ${exp > now ? 'Yes' : 'No (EXPIRED)'}</p>`;
                } catch (e) {
                    status += `<p><strong>Token Valid:</strong> No (Invalid format)</p>`;
                }
            }
            
            document.getElementById('authStatus').innerHTML = status;
        }

        async function testLogin() {
            const result = document.getElementById('loginResult');
            result.innerHTML = 'Testing login...';
            
            try {
                const response = await fetch('http://localhost:5000/api/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'password123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<div class="success">‚úÖ Login successful! Token: ${data.token.substring(0, 20)}...</div>`;
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.data));
                } else {
                    result.innerHTML = `<div class="error">‚ùå Login failed: ${data.message}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        async function testAPI() {
            const result = document.getElementById('apiResult');
            result.innerHTML = 'Testing API access...';
            
            const token = localStorage.getItem('token');
            if (!token) {
                result.innerHTML = '<div class="error">‚ùå No token found. Please login first.</div>';
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<div class="success">‚úÖ API access successful! Found ${data.count || 0} products.</div>`;
                } else {
                    result.innerHTML = `<div class="error">‚ùå API access failed: ${data.message}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        function clearAuth() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            document.getElementById('clearResult').innerHTML = '<div class="success">‚úÖ Authentication cleared. Please refresh the page.</div>';
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        // Auto-check on load
        window.onload = function() {
            checkAuthStatus();
        };
    </script>
</body>
</html>
